#!/bin/sh
#set -x
#
# Generate patches
#
PATCHDIRS="
	eclipse-platform-parent
	eclipse.pde.build
	eclipse.platform.releng
	eclipse.platform.releng.tychoeclipsebuilder
	eclipse.platform.resources
	eclipse.platform.runtime
	eclipse.platform.swt
	eclipse.platform.swt.binaries
	eclipse.platform.team
	eclipse.platform.ua
	eclipse.platform.ui
	rt.equinox.bundles
	rt.equinox.framework
	rt.equinox.p2
"
if [ ! -x bin/$(basename $0) ]
then
	echo "ERROR: Run this from top level"
	exit 1
fi
. ./config.sh

AGGR_MODULE=$(basename $ECLIPSE_AGGR)
BASELINE=".baseline.${AGGR_MODULE}"
if [ ! -d ${BASELINE} ]
then
	echo "ERROR: run bin/prepare-tree"
	exit 1
fi

scrub_patches ()
{
	# scrub name and blank out timestamps
	sed -E \
"s|../${BASELINE}/||
s/^(-{3} .*	)[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{9} .[0-9]{4}/\10000-00-00 00:00:00.000000000 +0000/
s/^(\+{3} .*	)[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{9} .[0-9]{4}/\10000-00-00 00:00:00.000000000 +0000/
/^Only in ${1}.*/d"
}

mkdir -p patches
for DIR in ${PATCHDIRS}
do
	echo "INFO: Inspecting ${DIR}"
	(
		cd ${AGGR_MODULE}
		diff -ru ../${BASELINE}/${DIR} ${DIR}
	) | scrub_patches ${DIR} > patches/patch-${DIR}
done

#!/bin/sh
#set -x
#
# Attempt eclipse build
#
ARCH=$(uname -p)
export MAVEN_OPTS="-Xmx1024m"

if [ ! -x bin/$(basename $0) ]
then
	echo "ERROR: Run this from top level"
	exit 1
fi
. ./config.sh

TOP_MODULE=$(basename $ECLIPSE_TOP)
if [ ! -d ${TOP_MODULE} ]
then
	echo "ERROR: bin/prepare-tree and bin/patch-apply needs to be run first"
	exit 1
fi

BUILD_SUFFIX=$(echo $* | tr -d '[:space:]')

REPO="maven-repo.${ECLIPSE_TAG}"
mkdir -p ${REPO}
REPO_PATH=$(realpath ${REPO})
(
	cd ${TOP_MODULE}
	mvn $* \
		-DskipTests=true \
		-Dmaven.repo.local=${REPO_PATH} \
		-Dnative=gtk.freebsd.${ARCH} \
		clean verify 2>&1
) | tee build-$(date '+%Y%m%d-%H%M')${BUILD_SUFFIX}.log

RESULT="org.eclipse.sdk.ide-freebsd.gtk.${ARCH}.tar.gz"
SOURCE="${TOP_MODULE}/eclipse.platform.releng.aggregator/eclipse.platform.releng.tychoeclipsebuilder/sdk/target/products/${RESULT}"

rm -f ${RESULT}
if [ -e ${SOURCE} ]
then
	ln ${SOURCE} .
fi

#!/bin/sh
#set -x
#
# Generate patches
#
PATCHDIRS="
	eclipse-platform-parent
	eclipse.platform.releng
	eclipse.platform.releng.tychoeclipsebuilder
	eclipse.platform.resources
	eclipse.platform.team
	eclipse.platform.swt.binaries
	rt.equinox.bundles
	rt.equinox.framework
"
if [ ! -x bin/$(basename $0) ]
then
	echo "ERROR: Run this from top level"
	exit 1
fi
. ./config.sh

AGGR_MODULE=$(basename $ECLIPSE_AGGR)
if [ ! -d ${AGGR_MODULE}.base ]
then
	echo "ERROR: run bin/patch-prepare"
	exit 1
fi

scrub_patches ()
{
	# blank out timestamps
	sed -E \
's/^(-{3} .*	)[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{9} .[0-9]{4}/\10000-00-00 00:00:00.000000000 +0000/
s/^(\+{3} .*	)[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{9} .[0-9]{4}/\10000-00-00 00:00:00.000000000 +0000/'
}

mkdir -p patches
for DIR in ${PATCHDIRS}
do
	echo "INFO: Inspecting ${DIR}"
	(
		cd ${AGGR_MODULE}
		diff -ruN ../${AGGR_MODULE}.base/${DIR} ${DIR}
	) | scrub_patches > patches/patch-${DIR}
done
